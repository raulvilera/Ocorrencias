const SPREADSHEET_ID = "1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOVIAlo";
const STUDENT_SHEET_NAME = "BANCODEDADOSGERAL";
const OCCURRENCE_SHEET_NAME = "OCORRENCIASDOSPROFESSORES";

// Mapeamento de turmas para intervalos
const CLASS_RANGES = {
  "6° ANO A MANHA": "C3:C46",
  "6° ANO B MANHA": "H3:H46",
  "6° ANO C MANHA": "M3:M46",
  "6° ANO D MANHA": "R3:R46",
  "6° ANO E TARDE": "W3:W46",
  "6° ANO F TARDE": "AB3:AB46",
  "7° ANO A TARDE": "AG3:AG46",
  "7° ANO B TARDE": "AL3:AL46",
  "7° ANO C TARDE": "AQ3:AQ46",
  "7° ANO D TARDE": "AV3:AV46",
  "7° ANO E TARDE": "BA3:BA46",
  "7° ANO F TARDE": "BF3:BF46",
  "8° ANO A TARDE": "BK3:BK46",
  "8° ANO B TARDE": "BP3:BP46",
  "8° ANO C TARDE": "BU3:BU46",
  "8° ANO D TARDE": "BZ3:BZ46",
  "9° ANO A TARDE": "CE3:CE46",
  "9° ANO B TARDE": "CJ3:CJ46",
  "9° ANO C TARDE": "CO3:CO46",
  "9° ANO D TARDE": "CT3:CT46",
  "1ª SERIE A MANHA": "CY3:CY46",
  "1ª SERIE B MANHA": "DD3:DD46",
  "1ª SERIE C MANHA": "DI3:DI46",
  "1ª SERIE D MANHA": "DN3:DN46",
  "1ª SERIE E MANHA": "DS3:DS46",
  "1ª SERIE F MANHA": "DX3:DX46",
  "1ª SERIE G TARDE": "EC3:EC46",
  "1ª SERIE H NOITE": "EH3:EH46",
  "1ª SERIE I NOITE": "EM3:EM46",
  "2ª SERIE A MANHA": "ER3:ER46",
  "2ª SERIE B MANHA": "EW3:EW46",
  "2ª SERIE C MANHA": "FB3:FB46",
  "2ª SERIE D MANHA": "FG3:FG46",
  "2ª SERIE E MANHA": "FL3:FL46",
  "2ª SERIE F NOITE": "FQ3:FQ46",
  "2ª SERIE G NOITE": "FV3:FV46",
  "2ª SERIE H NOITE": "GA3:GA46",
  "3ª SERIE A MANHA": "GK3:GK46",
  "3ª SERIE B MANHA": "GP3:GP46",
  "3ª SERIE C MANHA": "GU3:GU46",
  "3ª SERIE D NOITE": "GZ3:GZ46",
  "3ª SERIE E NOITE": "HE3:HE46",
  "3ª SERIE F NOITE": "HJ3:HJ46",
  "3ª SERIE G NOITE": "HO3:HO46",
  "4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA": "ER3:ER46"
};

function doPost(e) {
  try {
    // Validação do objeto 'e'
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error("Objeto de requisição inválido");
    }

    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(OCCURRENCE_SHEET_NAME);

    const newRow = [
      new Date(),
      data.professor,
      data.occurrenceDate,
      data.student,
      data.classInfo,
      data.irregularities,
      data.description
    ];

    sheet.appendRow(newRow);

    const stats = calculateStatistics(ss);

    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "Ocorrência registrada!",
      totalOccurrences: stats.totalOccurrences,
      totalStudents: stats.totalStudents
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const action = e.parameter.action;

  if (action === "getStudents") {
    const className = e.parameter.class;
    if (!className || !CLASS_RANGES[className]) {
      return ContentService.createTextOutput(JSON.stringify({
        status: "error",
        message: "Classe não encontrada"
      })).setMimeType(ContentService.MimeType.JSON);
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(STUDENT_SHEET_NAME);
    const range = sheet.getRange(CLASS_RANGES[className]);
    const values = range.getValues();

    // Filtrar valores vazios
    const students = [];
    for (let i = 0; i < values.length; i++) {
      if (values[i][0] && values[i][0].toString().trim() !== "") {
        students.push(values[i][0].toString().trim());
      }
    }

    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      students: students
    })).setMimeType(ContentService.MimeType.JSON);
  } else if (action === "getStats") {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const stats = calculateStatistics(ss);
    
    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      totalOccurrences: stats.totalOccurrences,
      totalStudents: stats.totalStudents
    })).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({
    status: "error",
    message: "Ação não suportada"
  })).setMimeType(ContentService.MimeType.JSON);
}

function calculateStatistics(ss) {
  const sheet = ss.getSheetByName(OCCURRENCE_SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  // Remover cabeçalho
  data.shift();

  // Calcular total de ocorrências
  const totalOccurrences = data.length;

  // Calcular total de alunos únicos
  const uniqueStudents = new Set();
  for (let i = 0; i < data.length; i++) {
    uniqueStudents.add(data[i][3]); // Nome do aluno está na coluna 3
  }

  return {
    totalOccurrences: totalOccurrences,
    totalStudents: uniqueStudents.size
  };
}
